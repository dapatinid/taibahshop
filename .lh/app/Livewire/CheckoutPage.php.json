{
    "sourceFile": "app/Livewire/CheckoutPage.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 26,
            "patches": [
                {
                    "date": 1732193125556,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1732193248437,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -153,8 +153,12 @@\n         $payment = new Payment();\n         $payment->date_payment = date('Y-m-d H:i:s');\n         $payment->currency = 'idr';\n         $payment->payment_method = $this->payment_method;\n+        $payment->nominal = $this->nominal;\n+        $payment->created_by = auth()->user()->id;\n+        $payment->updated_by = auth()->user()->id;\n+        $payment->branch_id = $this->branch_id;\n \n \n         $address = new Address();\n         $address->first_name = $this->first_name;\n"
                },
                {
                    "date": 1732193329298,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,231 @@\n+<?php\n+\n+namespace App\\Livewire;\n+\n+use App\\Helpers\\CartManagement;\n+use App\\Livewire\\Partials\\Navbar;\n+use App\\Mail\\OrderPlaced;\n+use App\\Models\\Address;\n+use App\\Models\\Branch;\n+use App\\Models\\Order;\n+use App\\Models\\Payment;\n+use App\\Models\\User;\n+use Illuminate\\Support\\Facades\\Mail;\n+use Livewire\\Attributes\\On;\n+use Livewire\\Attributes\\Title;\n+use Livewire\\Attributes\\Url;\n+use Livewire\\Component;\n+use Vermaysha\\Wilayah\\Models\\City;\n+use Vermaysha\\Wilayah\\Models\\District;\n+use Vermaysha\\Wilayah\\Models\\Province;\n+use Vermaysha\\Wilayah\\Models\\Village;\n+\n+#[Title('Checkout')]\n+class CheckoutPage extends Component\n+{\n+    #[Url()]\n+    public $sales_type;\n+    #[Url()]\n+    public $branch_id;\n+    #[Url()]\n+    public $user_id;\n+    #[Url()]\n+    public $discount;\n+    #[Url()]\n+    public $shipping_method;\n+    #[Url()]\n+    public $shipping_amount;\n+\n+    public $first_name;\n+    public $last_name;\n+    public $phone;\n+    public $street_address;\n+    public $village;\n+    public $district;\n+    public $city;\n+    public $state;\n+    public $zip_code;\n+    public $payment_method;\n+    public $notes;\n+\n+    public function mount()\n+    {\n+        $cart_items = CartManagement::getCartItemsFromCookie();\n+        if (count($cart_items) == 0) {\n+            return redirect('/products');\n+        }\n+    }\n+\n+    public function placeOrder()\n+    {\n+        $isadmin = auth()->user()->is_admin;\n+\n+        $this->validate([\n+            'sales_type' => 'required',\n+            'payment_method' => 'required',\n+            'branch_id' => 'required',\n+        ]);\n+\n+        if ($isadmin == 1) {\n+            $this->validate([\n+                'user_id' => 'required',\n+                'discount' => 'required|min:0',\n+                'shipping_method' => 'required',\n+                'shipping_amount' => 'required|min:0',\n+            ]);\n+        }\n+\n+        if ($isadmin == 0) {\n+\n+            if ($this->sales_type == 'delivery') {\n+                $this->validate([\n+                    'first_name' => 'required',\n+                    'last_name' => 'required',\n+                    'phone' => 'required',\n+                    'street_address' => 'required',\n+                    'village' => 'required',\n+                    'district' => 'required',\n+                    'city' => 'required',\n+                    'state' => 'required',\n+                    // 'zip_code' => 'required',\n+                ]);\n+            }\n+\n+            if ($this->sales_type == 'self_pickup') {\n+                $this->validate([\n+                    'first_name' => 'required',\n+                    'last_name' => 'required',\n+                    'phone' => 'required',\n+                ]);\n+            }\n+            if ($this->sales_type == 'dine_in') {\n+                $this->validate([\n+                    'first_name' => 'required',\n+                    'last_name' => 'required',\n+                    'phone' => 'required',\n+                ]);\n+            }\n+        }\n+\n+        $cart_items = CartManagement::getCartItemsFromCookie();\n+\n+        $line_items = [];\n+\n+        foreach ($cart_items as $item) {\n+            $line_items[] = [\n+                'price_data' => [\n+                    'currency' => 'idr',\n+                    'unit_amount' => $item['unit_amount'] * 100,\n+                    'product_data' => [\n+                        'name' => $item['name'],\n+                    ]\n+                ],\n+                'quantity' => $item['quantity'],\n+                'mutation_type' => 'Sales',\n+                'branch_id' => $this->branch_id,\n+            ];\n+        }\n+\n+        $order = new Order();\n+        $order->branch_id = $this->branch_id;\n+        $order->date_order = date('Y-m-d H:i:s');\n+        $order->code_tr = 'ORD' . date('YmdHis');\n+        $order->created_by = auth()->user()->id;\n+        $order->updated_by = auth()->user()->id;\n+        $order->grand_total = CartManagement::calculateGrandTotal($cart_items) - $this->discount + $this->shipping_amount;\n+        $order->sales_type = $this->sales_type;\n+        if ($this->nominal >= $order->grand_total) {\n+            $order->is_paid = 1;\n+        } else {\n+            $order->is_paid = 0;\n+        }\n+        $order->status = 'new';\n+        $order->notes =  $this->notes . PHP_EOL . PHP_EOL . 'Order placed by ' . PHP_EOL . auth()->user()->name . ' <' . auth()->user()->email . '>';\n+        // PHP_EOL untuk enter textarea\n+        if ($isadmin == 1) {\n+            $order->user_id = $this->user_id;\n+            $order->shipping_method = $this->shipping_method;\n+            $order->shipping_amount = $this->shipping_amount;\n+            $order->discount = $this->discount;\n+        } else {\n+            $order->user_id = auth()->user()->id;\n+            $order->shipping_method = 'kurir_taibah';\n+            $order->shipping_amount = 0;\n+            $order->discount = 0;\n+        }\n+\n+        $payment = new Payment();\n+        $payment->date_payment = date('Y-m-d H:i:s');\n+        $payment->currency = 'idr';\n+        $payment->payment_method = $this->payment_method;\n+        $payment->nominal = $this->nominal;\n+        $payment->created_by = auth()->user()->id;\n+        $payment->updated_by = auth()->user()->id;\n+        $payment->branch_id = $this->branch_id;\n+\n+\n+        $address = new Address();\n+        $address->first_name = $this->first_name;\n+        $address->last_name = $this->last_name;\n+        $address->phone = $this->phone;\n+        $address->street_address = $this->street_address;\n+        $address->village = $this->village;\n+        $address->district = $this->district;\n+        $address->city = $this->city;\n+        $address->state = $this->state;\n+        $address->zip_code = $this->zip_code;\n+\n+        $redirect_url = '';\n+\n+        if ($this->payment_method == 'stripe') {\n+            $redirect_url = route('success');\n+        } else {\n+            $redirect_url = route('success');\n+        }\n+\n+        $order->save();\n+        $address->order_id = $order->id;\n+        $address->save();\n+        $order->items()->createMany($cart_items);\n+        CartManagement::clearCartItems();\n+        Mail::to(request()->user())->send(new OrderPlaced($order));\n+        Mail::to('taibah.fc@gmail.com')->send(new OrderPlaced($order));\n+        return redirect($redirect_url);\n+    }\n+\n+\n+    public function removeItem($product_id)\n+    {\n+        CartManagement::removeCartItem($product_id);\n+        $this->dispatch('$refresh');\n+    }\n+\n+\n+    public function render()\n+    {\n+        $cart_items = CartManagement::getCartItemsFromCookie();\n+        $subtotal = CartManagement::calculateGrandTotal($cart_items);\n+        $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n+        $states = Province::all();\n+        $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n+        $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n+        $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n+\n+        $users = User::all();\n+        $branches = Branch::all();\n+\n+        return view('livewire.checkout-page', [\n+            'cart_items' => $cart_items,\n+            'subtotal' => $subtotal,\n+            'grand_total' => $grand_total,\n+            'states' => $states,\n+            'cities' => $cities,\n+            'districts' => $districts,\n+            'villages' => $villages,\n+            'users' => $users,\n+            'branches' => $branches,\n+            'discount' => $this->discount,\n+            'shipping_amount' => $this->shipping_amount,\n+        ]);\n+    }\n+}\n"
                },
                {
                    "date": 1732193471831,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -146,8 +146,11 @@\n             $order->user_id = $this->user_id;\n             $order->shipping_method = $this->shipping_method;\n             $order->shipping_amount = $this->shipping_amount;\n             $order->discount = $this->discount;\n+            $order->total_payment = $this->total_payment;\n+            $order->total_cashback = $this->total_payment - $order->grand_total - $this->discount + $this->shipping_amount;\n+            \n         } else {\n             $order->user_id = auth()->user()->id;\n             $order->shipping_method = 'kurir_taibah';\n             $order->shipping_amount = 0;\n"
                },
                {
                    "date": 1732193486073,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -133,9 +133,9 @@\n         $order->created_by = auth()->user()->id;\n         $order->updated_by = auth()->user()->id;\n         $order->grand_total = CartManagement::calculateGrandTotal($cart_items) - $this->discount + $this->shipping_amount;\n         $order->sales_type = $this->sales_type;\n-        if ($this->nominal >= $order->grand_total) {\n+        if ($this->total_payment >= $order->grand_total) {\n             $order->is_paid = 1;\n         } else {\n             $order->is_paid = 0;\n         }\n@@ -159,9 +159,9 @@\n         $payment = new Payment();\n         $payment->date_payment = date('Y-m-d H:i:s');\n         $payment->currency = 'idr';\n         $payment->payment_method = $this->payment_method;\n-        $payment->nominal = $this->nominal;\n+        $payment->nominal = $this->total_payment;\n         $payment->created_by = auth()->user()->id;\n         $payment->updated_by = auth()->user()->id;\n         $payment->branch_id = $this->branch_id;\n \n"
                },
                {
                    "date": 1732194076597,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,13 +29,15 @@\n     public $branch_id;\n     #[Url()]\n     public $user_id;\n     #[Url()]\n-    public $discount;\n+    public $discount = 0;\n     #[Url()]\n     public $shipping_method;\n     #[Url()]\n-    public $shipping_amount;\n+    public $shipping_amount = 0;\n+    #[Url()]\n+    public $total_payment = 0;\n \n     public $first_name;\n     public $last_name;\n     public $phone;\n"
                },
                {
                    "date": 1732194207822,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -209,8 +209,9 @@\n     {\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n+        $total_cashback = $this->total_payment - $grand_total;\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n@@ -229,7 +230,8 @@\n             'users' => $users,\n             'branches' => $branches,\n             'discount' => $this->discount,\n             'shipping_amount' => $this->shipping_amount,\n+            'total_cashback' => $total_cashback,\n         ]);\n     }\n }\n"
                },
                {
                    "date": 1732194407693,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -187,8 +187,10 @@\n             $redirect_url = route('success');\n         }\n \n         $order->save();\n+        $payment->order_id = $order->id;\n+        $payment->save();\n         $address->order_id = $order->id;\n         $address->save();\n         $order->items()->createMany($cart_items);\n         CartManagement::clearCartItems();\n"
                },
                {
                    "date": 1732194426959,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,9 +71,9 @@\n         if ($isadmin == 1) {\n             $this->validate([\n                 'user_id' => 'required',\n                 'discount' => 'required|min:0',\n-                'shipping_method' => 'required',\n+                // 'shipping_method' => 'required',\n                 'shipping_amount' => 'required|min:0',\n             ]);\n         }\n \n"
                },
                {
                    "date": 1732196278529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,8 +212,9 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n+        $total_payment = $this->total_payment;\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n@@ -233,7 +234,8 @@\n             'branches' => $branches,\n             'discount' => $this->discount,\n             'shipping_amount' => $this->shipping_amount,\n             'total_cashback' => $total_cashback,\n+            'total_payment' => $total_payment,\n         ]);\n     }\n }\n"
                },
                {
                    "date": 1732201513770,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,9 +35,9 @@\n     public $shipping_method;\n     #[Url()]\n     public $shipping_amount = 0;\n     #[Url()]\n-    public $total_payment = 0;\n+    public $total_payment = '';\n \n     public $first_name;\n     public $last_name;\n     public $phone;\n"
                },
                {
                    "date": 1732201534963,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,9 +35,9 @@\n     public $shipping_method;\n     #[Url()]\n     public $shipping_amount = 0;\n     #[Url()]\n-    public $total_payment = '';\n+    public $total_payment = 0;\n \n     public $first_name;\n     public $last_name;\n     public $phone;\n"
                },
                {
                    "date": 1732202505634,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,9 +212,8 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n-        $total_payment = $this->total_payment;\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n@@ -234,8 +233,7 @@\n             'branches' => $branches,\n             'discount' => $this->discount,\n             'shipping_amount' => $this->shipping_amount,\n             'total_cashback' => $total_cashback,\n-            'total_payment' => $total_payment,\n         ]);\n     }\n }\n"
                },
                {
                    "date": 1732202569495,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,8 +73,9 @@\n                 'user_id' => 'required',\n                 'discount' => 'required|min:0',\n                 // 'shipping_method' => 'required',\n                 'shipping_amount' => 'required|min:0',\n+                'total_payment' => 'required|min:0',\n             ]);\n         }\n \n         if ($isadmin == 0) {\n"
                },
                {
                    "date": 1732202603672,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,9 +73,9 @@\n                 'user_id' => 'required',\n                 'discount' => 'required|min:0',\n                 // 'shipping_method' => 'required',\n                 'shipping_amount' => 'required|min:0',\n-                'total_payment' => 'required|min:0',\n+                'total_payment' => 'required|min:0|min:999999999999999',\n             ]);\n         }\n \n         if ($isadmin == 0) {\n"
                },
                {
                    "date": 1732202721380,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,9 +73,8 @@\n                 'user_id' => 'required',\n                 'discount' => 'required|min:0',\n                 // 'shipping_method' => 'required',\n                 'shipping_amount' => 'required|min:0',\n-                'total_payment' => 'required|min:0|min:999999999999999',\n             ]);\n         }\n \n         if ($isadmin == 0) {\n@@ -212,9 +211,9 @@\n     {\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n-        $total_cashback = $this->total_payment - $grand_total;\n+        // $total_cashback = $this->total_payment - $grand_total;\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n"
                },
                {
                    "date": 1732202729464,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -232,8 +232,8 @@\n             'users' => $users,\n             'branches' => $branches,\n             'discount' => $this->discount,\n             'shipping_amount' => $this->shipping_amount,\n-            'total_cashback' => $total_cashback,\n+            // 'total_cashback' => $total_cashback,\n         ]);\n     }\n }\n"
                },
                {
                    "date": 1732202769284,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -211,9 +211,9 @@\n     {\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n-        // $total_cashback = $this->total_payment - $grand_total;\n+        $total_cashback = $this->total_payment - $grand_total;\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n@@ -232,8 +232,8 @@\n             'users' => $users,\n             'branches' => $branches,\n             'discount' => $this->discount,\n             'shipping_amount' => $this->shipping_amount,\n-            // 'total_cashback' => $total_cashback,\n+            'total_cashback' => $total_cashback,\n         ]);\n     }\n }\n"
                },
                {
                    "date": 1732202944077,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,8 +212,9 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n+        $total_payment = $this->total_payment;\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n@@ -233,7 +234,8 @@\n             'branches' => $branches,\n             'discount' => $this->discount,\n             'shipping_amount' => $this->shipping_amount,\n             'total_cashback' => $total_cashback,\n+            'total_payment' => @currency($total_payment),\n         ]);\n     }\n }\n"
                },
                {
                    "date": 1732203017544,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -234,8 +234,8 @@\n             'branches' => $branches,\n             'discount' => $this->discount,\n             'shipping_amount' => $this->shipping_amount,\n             'total_cashback' => $total_cashback,\n-            'total_payment' => @currency($total_payment),\n+            'total_payment' => $total_payment,\n         ]);\n     }\n }\n"
                },
                {
                    "date": 1732203395720,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,9 +212,9 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n-        $total_payment = $this->total_payment;\n+        $total_payment = number_format($this->total_payment, 0, '', '');\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n"
                },
                {
                    "date": 1732203460449,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,9 +212,9 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n-        $total_payment = number_format($this->total_payment, 0, '', '');\n+        $total_payment = @currency($this->total_payment, 0, '', '');\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n"
                },
                {
                    "date": 1732203490575,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,8 +10,9 @@\n use App\\Models\\Order;\n use App\\Models\\Payment;\n use App\\Models\\User;\n use Illuminate\\Support\\Facades\\Mail;\n+use Illuminate\\Support\\Number;\n use Livewire\\Attributes\\On;\n use Livewire\\Attributes\\Title;\n use Livewire\\Attributes\\Url;\n use Livewire\\Component;\n@@ -212,9 +213,9 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n-        $total_payment = @currency($this->total_payment, 0, '', '');\n+        $total_payment = Number::currency($this->total_payment, 0, '', '');\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n"
                },
                {
                    "date": 1732203530878,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,9 +10,8 @@\n use App\\Models\\Order;\n use App\\Models\\Payment;\n use App\\Models\\User;\n use Illuminate\\Support\\Facades\\Mail;\n-use Illuminate\\Support\\Number;\n use Livewire\\Attributes\\On;\n use Livewire\\Attributes\\Title;\n use Livewire\\Attributes\\Url;\n use Livewire\\Component;\n@@ -213,9 +212,9 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n-        $total_payment = Number::currency($this->total_payment, 0, '', '');\n+        $total_payment = $this->total_payment; \n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n"
                },
                {
                    "date": 1732203685793,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -59,8 +59,9 @@\n     }\n \n     public function placeOrder()\n     {\n+        $this->total_payment = floatval(preg_replace('/[^\\d.]/', '', $this->total_payment));\n         $isadmin = auth()->user()->is_admin;\n \n         $this->validate([\n             'sales_type' => 'required',\n"
                },
                {
                    "date": 1732203755863,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -59,9 +59,8 @@\n     }\n \n     public function placeOrder()\n     {\n-        $this->total_payment = floatval(preg_replace('/[^\\d.]/', '', $this->total_payment));\n         $isadmin = auth()->user()->is_admin;\n \n         $this->validate([\n             'sales_type' => 'required',\n@@ -213,9 +212,10 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n-        $total_payment = $this->total_payment;\n+        $total_payment =  floatval(preg_replace('/[^\\d.]/', '', $this->total_payment));\n+        \n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n"
                },
                {
                    "date": 1732203776300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -212,10 +212,9 @@\n         $cart_items = CartManagement::getCartItemsFromCookie();\n         $subtotal = CartManagement::calculateGrandTotal($cart_items);\n         $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n         $total_cashback = $this->total_payment - $grand_total;\n-        $total_payment =  floatval(preg_replace('/[^\\d.]/', '', $this->total_payment));\n-\n+        $total_payment = $this->total_payment;\n         $states = Province::all();\n         $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n         $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n         $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n"
                }
            ],
            "date": 1732193125556,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace App\\Livewire;\n\nuse App\\Helpers\\CartManagement;\nuse App\\Livewire\\Partials\\Navbar;\nuse App\\Mail\\OrderPlaced;\nuse App\\Models\\Address;\nuse App\\Models\\Branch;\nuse App\\Models\\Order;\nuse App\\Models\\Payment;\nuse App\\Models\\User;\nuse Illuminate\\Support\\Facades\\Mail;\nuse Livewire\\Attributes\\On;\nuse Livewire\\Attributes\\Title;\nuse Livewire\\Attributes\\Url;\nuse Livewire\\Component;\nuse Vermaysha\\Wilayah\\Models\\City;\nuse Vermaysha\\Wilayah\\Models\\District;\nuse Vermaysha\\Wilayah\\Models\\Province;\nuse Vermaysha\\Wilayah\\Models\\Village;\n\n#[Title('Checkout')]\nclass CheckoutPage extends Component\n{\n    #[Url()]\n    public $sales_type;\n    #[Url()]\n    public $branch_id;\n    #[Url()]\n    public $user_id;\n    #[Url()]\n    public $discount;\n    #[Url()]\n    public $shipping_method;\n    #[Url()]\n    public $shipping_amount;\n\n    public $first_name;\n    public $last_name;\n    public $phone;\n    public $street_address;\n    public $village;\n    public $district;\n    public $city;\n    public $state;\n    public $zip_code;\n    public $payment_method;\n    public $notes;\n\n    public function mount()\n    {\n        $cart_items = CartManagement::getCartItemsFromCookie();\n        if (count($cart_items) == 0) {\n            return redirect('/products');\n        }\n    }\n\n    public function placeOrder()\n    {\n        $isadmin = auth()->user()->is_admin;\n\n        $this->validate([\n            'sales_type' => 'required',\n            'payment_method' => 'required',\n            'branch_id' => 'required',\n        ]);\n\n        if ($isadmin == 1) {\n            $this->validate([\n                'user_id' => 'required',\n                'discount' => 'required|min:0',\n                'shipping_method' => 'required',\n                'shipping_amount' => 'required|min:0',\n            ]);\n        }\n\n        if ($isadmin == 0) {\n\n            if ($this->sales_type == 'delivery') {\n                $this->validate([\n                    'first_name' => 'required',\n                    'last_name' => 'required',\n                    'phone' => 'required',\n                    'street_address' => 'required',\n                    'village' => 'required',\n                    'district' => 'required',\n                    'city' => 'required',\n                    'state' => 'required',\n                    // 'zip_code' => 'required',\n                ]);\n            }\n\n            if ($this->sales_type == 'self_pickup') {\n                $this->validate([\n                    'first_name' => 'required',\n                    'last_name' => 'required',\n                    'phone' => 'required',\n                ]);\n            }\n            if ($this->sales_type == 'dine_in') {\n                $this->validate([\n                    'first_name' => 'required',\n                    'last_name' => 'required',\n                    'phone' => 'required',\n                ]);\n            }\n        }\n\n        $cart_items = CartManagement::getCartItemsFromCookie();\n\n        $line_items = [];\n\n        foreach ($cart_items as $item) {\n            $line_items[] = [\n                'price_data' => [\n                    'currency' => 'idr',\n                    'unit_amount' => $item['unit_amount'] * 100,\n                    'product_data' => [\n                        'name' => $item['name'],\n                    ]\n                ],\n                'quantity' => $item['quantity'],\n                'mutation_type' => 'Sales',\n                'branch_id' => $this->branch_id,\n            ];\n        }\n\n        $order = new Order();\n        $order->branch_id = $this->branch_id;\n        $order->date_order = date('Y-m-d H:i:s');\n        $order->code_tr = 'ORD' . date('YmdHis');\n        $order->created_by = auth()->user()->id;\n        $order->updated_by = auth()->user()->id;\n        $order->grand_total = CartManagement::calculateGrandTotal($cart_items) - $this->discount + $this->shipping_amount;\n        $order->sales_type = $this->sales_type;\n        $order->is_paid = 0;\n        $order->status = 'new';\n        $order->notes =  $this->notes . PHP_EOL . PHP_EOL . 'Order placed by ' . PHP_EOL . auth()->user()->name . ' <' . auth()->user()->email . '>';\n        // PHP_EOL untuk enter textarea\n        if ($isadmin == 1) {\n            $order->user_id = $this->user_id;\n            $order->shipping_method = $this->shipping_method;\n            $order->shipping_amount = $this->shipping_amount;\n            $order->discount = $this->discount;\n        } else {\n            $order->user_id = auth()->user()->id;\n            $order->shipping_method = 'kurir_taibah';\n            $order->shipping_amount = 0;\n            $order->discount = 0;\n        }\n\n        $payment = new Payment();\n        $payment->date_payment = date('Y-m-d H:i:s');\n        $payment->currency = 'idr';\n        $payment->payment_method = $this->payment_method;\n\n\n        $address = new Address();\n        $address->first_name = $this->first_name;\n        $address->last_name = $this->last_name;\n        $address->phone = $this->phone;\n        $address->street_address = $this->street_address;\n        $address->village = $this->village;\n        $address->district = $this->district;\n        $address->city = $this->city;\n        $address->state = $this->state;\n        $address->zip_code = $this->zip_code;\n\n        $redirect_url = '';\n\n        if ($this->payment_method == 'stripe') {\n            $redirect_url = route('success');\n        } else {\n            $redirect_url = route('success');\n        }\n\n        $order->save();\n        $address->order_id = $order->id;\n        $address->save();\n        $order->items()->createMany($cart_items);\n        CartManagement::clearCartItems();\n        Mail::to(request()->user())->send(new OrderPlaced($order));\n        Mail::to('taibah.fc@gmail.com')->send(new OrderPlaced($order));\n        return redirect($redirect_url);\n    }\n\n\n    public function removeItem($product_id)\n    {\n        CartManagement::removeCartItem($product_id);\n        $this->dispatch('$refresh');\n    }\n\n\n    public function render()\n    {\n        $cart_items = CartManagement::getCartItemsFromCookie();\n        $subtotal = CartManagement::calculateGrandTotal($cart_items);\n        $grand_total = $subtotal - $this->discount + $this->shipping_amount;\n        $states = Province::all();\n        $cities = City::all()->where('province_code', $this->state)->sortByDesc('name');\n        $districts = District::all()->where('city_code', $this->city)->sortBy('name');\n        $villages = Village::all()->where('district_code', $this->district)->sortBy('name');\n\n        $users = User::all();\n        $branches = Branch::all();\n\n        return view('livewire.checkout-page', [\n            'cart_items' => $cart_items,\n            'subtotal' => $subtotal,\n            'grand_total' => $grand_total,\n            'states' => $states,\n            'cities' => $cities,\n            'districts' => $districts,\n            'villages' => $villages,\n            'users' => $users,\n            'branches' => $branches,\n            'discount' => $this->discount,\n            'shipping_amount' => $this->shipping_amount,\n        ]);\n    }\n}\n"
        }
    ]
}